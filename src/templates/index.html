<!DOCTYPE html>
<html lang = "en">
   <head>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
      <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>   
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
      <link rel="stylesheet" href="../static/style.css">
   </head>
   <body>
        <div class="container cont-main-page">
            <h1>Storkoprístroj 3000</h1>

            <div id="create-stories-form">
                <form>
                    <label for="site">Vyber si stránku:</label>
                    <select id="site" name="site">
                        <option value="ht">Hashtag</option>
                        <option value="pe">Plní Elánu</option>
                    </select>
                    <div id="links-articles">
                        <label for="articles"> Vlož odkazy na články:</label>
                        <input type="text" id="article-link1" name="article-link1" class="article-link">
                    </div>
                    <button type="button" onclick="addInput()" class="add-more-button">+</button>
                    <button type="button" id="create">Vytvor storky</button>
                </form>
            <div>
        </div>
        
       <script>
           $(document).ready(function(){
               $("#create").click(function(){
                    var site = $('#site').val();
                    var links = []
                    
                    $('.article-link').each(function() {
                        links.push($(this).val());
                    });

                    console.log("Site:", site);
                    console.log("Links:", links);
                    
                    fetch(`/get_posts_data?site=${site}&links=${links}`, {
                        method: "GET"
                    })
                    .then(response => response.json())
                    .then(postsData => {
                        data_posts = JSON.stringify(postsData);
                        return fetch(`/get_stories_template?site=${site}`, {
                            method: "GET"
                        });
                    })
                    .then(response => response.json())
                    .then(templateData => {
                        template = JSON.stringify(templateData);
                        console.log("POSTS:", data_posts);
                        console.log("TEMPLATE:", template);
                        return fetch(`/get_posts_elements?posts=${data_posts}&template=${template}`, {
                            method: "GET"
                        });
                    })
                    .then(response => response.json())
                    .then(postsElementsList => {
                        posts_elements = postsElementsList;
                        return fetch(`/create_images`, {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                site: site,
                                posts_elements: posts_elements,
                            }),
                        });
                    })
                    .then(response => response.json())
                    .then(result => {
                        window.location.href = `/show_images?site=${site}`;
                    })


               });
           });

            function addInput() {
                var container = document.getElementById('links-articles');
                var count = container.children.length; - 1

                var input = document.createElement('input');
                input.type = 'text';
                input.className = 'article-link';
                input.id = 'article-link' + count;
                input.name = 'article-link' + count;
                container.appendChild(input);
            }
       </script>
   </body>   
</html>